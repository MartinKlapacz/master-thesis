\subsection{The Condition Predicate}\label{subsec:the-condition-predicate}

\subsubsection{Block Content Related Sub-rules}

A medical treatment consists of multiple stages of patient care.
Each stage has its specific aims and tools.
Anamnesis,
physical examination and procedures represent different stages of patient care and are highly relevant for billing.

\paragraph{Anamnesis}
Anamnesis is the first stage of a treatment.
Its purpose is to collect a detailed medical history from the patient\cite{lino2021medical}.
More specifically, it is about understanding the patient's general health conditions,
their lifestyle and previous patients' diagnoses.
If possible, the practitioner reviews available medical records,
interviews the patient directly or using a questionnaire\cite{zhang2011anamnevis}.

\paragraph{Physical Examination}
Anamnesis is followed by the Physical Examination.
In this practical stage, the practitioner assesses the current patient's conditions,
looking for further information about the patient's issues\cite{seidel2010mosby}.
The practitioner decides based on patient's symptoms which exact examinations are conducted.
Common examinations are checking of vital sings like blood pressure, pulse and temperature.

\paragraph{Procedures}
The procedure stage contains the actual patient-specific interventions that \todo

\paragraph{Block Contents}
During Anamnesis,
Physical Examination and Procedures the practitioner enters medical treatment specific information into the \AVS.
The data is part of the treatment documentation and critical for billing.

The documentations of all three stages are filled out by the practitioner and are structured in sections,
cards and blocks.

For example, inside the physical examination there is the section \mete{abdomen},
which contains the\mete{liver} section.
Blocks are essentially small questionnaires for the practitioner with input fields to be filled out by the practitioner.
They play a huge role in the treatment documentation
and contain all relevant medical information specific to this conducted examination,
procedure anamnesis.
One example for a physical block in the \code{liver}section is\code{LiverPalpation}.
A liver palpation involves investigating the following questions

\begin{itemize}
    \item Is the liver palpable?
    \item Is the liver texture soft or tender?
    \item Is the liver surface smooth or knotty?
    \item Is tenderness present?
    \item Are pulsations present?
    \item Is a hepato jugular reflux present?
\end{itemize}

Each of the more than 100 block contents in the \AVS are represented by a dedicated Hibernate entity classes.
Each attribute of that class stores a questionnaire input entered by the practitioner.
Additionally, for each entity, there is a protobuf message enabling transmission of block content data from one service
to another one.

The protobuf message of \code{LiverPalpationMsg} looks like this:

\lstinputlisting[
    language=protobuf2,
    style=protobuf,
    caption={LiverPalpation protobuf messages}
]{code/proto/liverPalpation.proto}

The exact principle is applied throughout all the procedures and anamnesis as well.
A crucial part of the rule language is not only to check for block content availabilities in the treatment
but also to look inside the blocks and check for conditions on fields.
A GOÄ code might have as a condition that a liver palpation examination is part of the treatment and
the liver turned out to be palpable.
Or an OPS code should only be derived if a \code{ECG}procedure was provided and the
input field\code{telemetricExamination} inside its block has the value\code{true}.
Logical combinations of such single field conditions may also occur.
Expressing such conditions in a well-defined and user-friendly way is an important requirement for the rule language.

\paragraph{Block Content Field Types}
A block content can contain information of different input types.
The billing framework must handle and validate each input type differently.

The most basic field types are boolean flags and numeric inputs.
The \AVS uses the following scalar wrapper protobuf messages for them:

\lstinputlisting[
    language=protobuf2,
    style=protobuf,
    caption={Scalar wrapper types}
]{code/proto/scalarWrapper.proto}

The purpose of wrapping scalars in custom protobuf messages is to make scalar default values distinguishable from missing data.
Initializing a protobuf message without explicitly setting the value of field has the consequence that the field gets initialized with its default value.
The default value for \code{int32} is 0.
If a gRPC server receives a protobuf message with an \code{int32} field set to 0, it does not know if the field was purposely initialized with 0 or not set at all.
Wrapping integers in \code{Int32W} messages makes this distinguishable.


Liver tenderness can either be present or not.
This information is thus entered in a \code{BoolW]} field.
We use enumeration fields for inputs that have a limited number of predefined values
For example, the most frequently used enum type is \code{AbnormalitiesExaminationResult}.
It denotes the result of a specific examination, which can be either conspicuous or inconspicuous.

\lstinputlisting[
    language=protobuf2,
    style=protobuf,
    caption={\code{AbnormalitiesExaminationResult}}
]{code/proto/enum.proto}

Knowledge inputs are another important input type.
They serve similar purposes as enum types but are not hard-coded into the code base.
The system fetches them from a dedicated microservice that stores them in a MeiliSearch database.

The \AVS reuses the concept auf storing medical data as protobuf message questionnaires accross the anamnesis, physical examination and procedure stages.

Block content conditions are a powerful tool to make codes dependent on concrete medical information from anamnesis,
physical examination and procedures.


\subsubsection{Time Related conditions}

\subsubsection{Medical Coding Related Conditions}

\subsubsection{Patient Related Conditions}

\paragraph{minPatientAge/maxPatientAge}
\code{minPatientAge} and \code{maxPatientAge} are integer fields that enable restrictions on the patient age.
Both fields store a number of years.
You can combine both to require the patient age to be within a certain age interval.

In medical practice, the age of a patient can significantly influence the complexity of a treatment.
In cases involving very young or very elderly patients, practitioners may encounter patient age specific challenges.
Due to these challenges, treatments may require more time, special care or other additional resources.
As a result, practitioners may apply billing multipliers to compensate for the additional effort.
This is why you can use the \code{minPatientAge} and \code{maxPatientAge} fields implement these types of multiplier justification rules.
There are also concrete GOÄ codes such as \goa{K1} and \goa{K2} that require the patient age.
The patient age is also highly relevant for various EBM codes, but already exists as structured conditions in the EBM catalog.
This is why using patient age conditions in EBM rules is redundant.
The information source for these two conditions is \code{@InformationSourcePatientAge}.

\paragraph{newBorn}
\code{newBorn} is syntactic sugar and a special case of the \code{maxPatientAge} condition.
It is a bool field that denotes whether a patient is a newborn or not.
According to the GOÄ, babies that are at most 28 days old are newborns\addcite.
It is relevant for \goa{25: Initial newborn examination – if necessary including advice from the caregiver(s) –}, which is essentially a provision of a physical examination for newborns.
It can also be interesting for multiplier justifications.
The information source for these two conditions is \code{@InformationSourcePatientAge}.

\paragraph{patientSpeaksGerman/patientSpeaksEnglish}
\code{patientSpeaksGerman} and \code{patientSpeaksEnglish} are both boolean fields that denote whether the patients are able to communicate in the respective language.
Communication problems can increase the effort and time a treatment may require and are often used as justifications for multipliers which compensate for that.
\goa{4: taking a third-party medical history} covers an anemnesis that

\paragraph{gender}
The \code{gender} condition is one of the most important condition types.
It is relevant for various EBM and GOÄ codes.
Similarly to patient age, gender conditions are already a structured part of the EBM catalog and do not need to be used in EBM rules.
\goa{27}, \goa{28},  GOÄ codes in section \mete{H}, Obstetrics and Gynecology, and GOÄ codes in \mete{Urology} are gender-specific.
Rules implementing these codes can use the \code{gender} condition.
It supports the string values \code{\"female\"}, \code{\"male\"} and \code{\"diverse\"}.
\code{gender} subscribes to the information source \code{@InformationSourcePatientGender}.


\paragraph{isPregnant}
The \code{isPregnant} condition is syntactic sugar for a specific case of the \code{requiredAnamnesisBlocks}
The following rules are equivalent.

\lstinputlisting[
    language=json,
    style=json,
    caption={\code{isPregnant} rule},
    label={lst:is-pregnant}
]{code/rules/specification/performerIsDoctor.json}

A pregnancy can be reason for additionally required care or services during a treatment that is not related to the patient's pregnancy.
This is why it can be useful in multiplier justification rules.
It is also useful for \goa{23} which is applicable for an initial pregnancy-related examination.
\code{isPregnant} subscribes to the information source \code{@InformationSourceAnamnesisBlocks}.

\paragraph{minNumberOfAllergies}
\code{minNumberOfAllergies} is a field that specifies the minimal number of allergies a patient requires.
From medical experts at \AV I have learned that a high number of allergies can make treatments more challenging for several reasons:
\begin{itemize}
    \item It may reduce the number of medical options as medications contain allergens or can produce them in specific environments.
    \item It can increase the complexity of the diagnostic process, as allergy reactions can mimic symptoms of other diagnoses.
    \item Patients with a high number of allergies require increased caution and care.
    Practitioners need to spend more time for history review and patient monitoring.
\end{itemize}
This makes \code{minNumberOfAllergies} a useful condition for multiplier justifications.
It subscribes to the information source \code{@InformationSourcePatientAllergies}

\subsubsection{Previous Occurrence related Conditions}

\subsubsection{Service Performer related Conditions}

\paragraph{performerIsDoctor}
The \code{performerIsDoctor} condition is a boolean condition field that allows to impose conditions on the practitioner type.
The current version of the \AVS supports the following practitioner types:

\lstinputlisting[
    language=protobuf2,
    style=protobuf,
    caption={\code{AbnormalitiesExaminationResult}},label={lst:AbnormalitiesExaminationResult}]{code/proto/roleTypes.proto}

Given the rules in code snippet \ref{lst:performerIsDoctor}, \code{code1} would hold if the practitioner had the role \code{ROLE\_TYPE\_DOCTOR}
or \code{ROLE\_TYPE\_HEAD\_DOCTOR}.
Otherwise, \code{code2} would hold.
This condition is relevant for \goa{1} and \goa{2}, which are only applicable by doctors.

\lstinputlisting[
    language=protobuf2,
    style=protobuf,
    caption={\code{AbnormalitiesExaminationResult}},
    label={lst:performerIsDoctor}
]{code/rules/specification/performerIsDoctor.json}

